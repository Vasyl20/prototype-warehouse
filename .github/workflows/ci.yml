name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ñ–Ğ²
      run: |
        cd test
        pytest test_app.py -v

    - name: ğŸ“Š Ğ¢ĞµÑÑ‚Ğ¸ Ğ· Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚ÑĞ¼ (Ğ¾Ğ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
      run: |
        pip install pytest-cov
        pytest test/test_app.py --cov=app --cov-report=term
      continue-on-error: true

  lint:
    name: ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ĞºĞ¾Ğ´Ñƒ
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ flake8
      run: pip install flake8

    - name: ğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº flake8
      run: flake8 app.py --max-line-length=120 --extend-ignore=E501,W503,E402
      continue-on-error: true

  docker:
    name: ğŸ³ Docker Ğ±Ñ–Ğ»Ğ´
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Ğ‘Ñ–Ğ»Ğ´ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñƒ
      run: docker build -t warehouse-app:latest .

    - name: âœ… ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ñƒ
      run: docker images | grep warehouse-app

  summary:
    name: ğŸ“Š ĞŸÑ–Ğ´ÑÑƒĞ¼Ğ¾Ğº
    runs-on: ubuntu-latest
    needs: [test, lint, docker]
    if: always()

    steps:
    - name: ğŸ‰ Ğ’ÑÑ– Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ–
      run: echo "âœ… CI/CD pipeline completed successfully!"