
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ñ–Ğ²
      run: |
        pytest test/test_app.py -v --cov=app --cov-report=xml --cov-report=term

    - name: ğŸ“Š Ğ—Ğ²Ñ–Ñ‚ Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  lint:
    name: ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ĞºĞ¾Ğ´Ñƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ flake8
      run: pip install flake8

    - name: ğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº flake8
      run: flake8 app.py --max-line-length=120 --extend-ignore=E501,W503
      continue-on-error: true

  docker:
    name: ğŸ³ Docker Ğ±Ñ–Ğ»Ğ´
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Ğ‘Ñ–Ğ»Ğ´ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñƒ
      run: docker build -t warehouse-app:latest .

    - name: ğŸ§ª Ğ¢ĞµÑÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
      run: |
        docker run -d -p 5000:5000 --name test-container warehouse-app:latest
        sleep 15
        docker ps | grep test-container
        docker stop test-container
        docker rm test-container
