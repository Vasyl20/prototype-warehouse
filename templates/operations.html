<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–û–ø–µ—Ä–∞—Ü—ñ—ó - –°–∫–ª–∞–¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/menu.css" rel="stylesheet">
  <style>
    .new-product-fields {
      background-color: #f8f9fa;
      border: 2px dashed #28a745;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }
    .product-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .product-type-btn {
      flex: 1;
    }
  </style>
</head>
<body class="p-4">

  <button class="toggle-btn" id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>

  <div class="sidebar" id="sidebar">
    <ul>
        <li><span class="me-3">üë§ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</span></li>
        <li><a href="/" class="btn btn-primary me-2">üì¶ –°–∫–ª–∞–¥</a></li>
        <li><a href="/suppliers" class="btn btn-success me-2">üè¢ –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏</a></li>
        <li><a href="/clients" class="btn btn-info me-2">üë• –ö–ª—ñ—î–Ω—Ç–∏</a></li>
        <li><a href="/relocation" class="btn btn-primary me-2">üîÅ –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤</a></li>
        <li><a href="/stock" class="btn btn-secondary me-2">üìä –ó–∞–ª–∏—à–∫–∏</a></li>
        <li><a href="/movement" class="btn btn-warning me-2">üìà –†—É—Ö —Ç–æ–≤–∞—Ä—ñ–≤</a></li>
        <li><a href="/operations" class="btn btn-info me-2">üìã –û–ø–µ—Ä–∞—Ü—ñ—ó</a></li>
        <li><a href="/dashboard" class="btn btn-success me-2">üìä –î–∞—à–±–æ—Ä–¥</a></li>
        <li><button class="btn btn-danger" id="logoutBtn">üö™ –í–∏–π—Ç–∏</button></li>
    </ul>
  </div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>üìä –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ —Ç–æ–≤–∞—Ä–∞–º–∏</h3>
      <div>
        <span class="me-3">üë§ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</span>
        <a href="/" class="btn btn-primary me-2">üì¶ –î–æ —Å–∫–ª–∞–¥—É</a>
        <a href="/suppliers" class="btn btn-success me-2">üè¢ –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏</a>
        <a href="/clients" class="btn btn-info me-2">üë• –ö–ª—ñ—î–Ω—Ç–∏</a>
        <a href="/stock" class="btn btn-warning me-2">üìä –ó–∞–ª–∏—à–∫–∏</a>
      </div>
    </div>

    <div class="row mb-4">
      <!-- –ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">‚ûï –ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">–î–∞—Ç–∞ *</label>
              <input type="date" id="incomeDate" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ *</label>
              <select id="incomeSupplier" class="form-select">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞...</option>
              </select>
            </div>

            <!-- –í–∏–±—ñ—Ä —Ç–∏–ø—É —Ç–æ–≤–∞—Ä—É -->
            <div class="mb-3">
              <label class="form-label">–¢–æ–≤–∞—Ä *</label>
              <div class="product-type-selector">
                <button type="button" class="btn btn-outline-primary product-type-btn" id="existingProductBtn" onclick="showExistingProduct()">
                  üìã –í–∏–±—Ä–∞—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π
                </button>
                <button type="button" class="btn btn-outline-success product-type-btn" id="newProductBtn" onclick="showNewProduct()">
                  ‚ûï –ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä
                </button>
              </div>

              <!-- –í–∏–±—ñ—Ä —ñ—Å–Ω—É—é—á–æ–≥–æ —Ç–æ–≤–∞—Ä—É -->
              <div id="existingProductSection">
                <select id="incomeProduct" class="form-select">
                  <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –∑—ñ —Å–∫–ª–∞–¥—É...</option>
                </select>
              </div>

              <!-- –§–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É -->
              <div id="newProductSection" style="display: none;" class="new-product-fields">
                <div class="mb-3">
                  <label class="form-label">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É *</label>
                  <input type="text" id="newProductName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ù–æ—É—Ç–±—É–∫ Dell Latitude">
                </div>
                <div class="mb-3">
                  <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª/–ù–æ–º–µ—Ä</label>
                  <input type="text" id="newProductNumber" class="form-control" placeholder="ART-1234">
                </div>
                <div class="mb-3">
                  <label class="form-label">–¶—ñ–Ω–∞ (–∑–∞ –æ–¥–∏–Ω–∏—Ü—é)</label>
                  <input type="number" id="newProductPrice" class="form-control" placeholder="0.00" step="0.01">
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">–°–∫–ª–∞–¥ *</label>
                    <input type="text" id="newProductWarehouse" class="form-control" placeholder="1">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">–°—Ç–µ–ª–∞–∂ *</label>
                    <input type="text" id="newProductShelf" class="form-control" placeholder="A">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">–ü–æ–ª–∏—Ü—è *</label>
                    <input type="text" id="newProductRack" class="form-control" placeholder="1">
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å *</label>
              <input type="number" id="incomeQty" class="form-control" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å" min="1">
            </div>

            <div class="mb-3">
              <label class="form-label">–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ—ó</label>
              <input type="text" id="incomeInvoice" class="form-control" placeholder="–ü–ù-1234">
            </div>

            <button class="btn btn-success w-100" id="addIncomeBtn">‚ûï –î–æ–¥–∞—Ç–∏ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</button>
          </div>
        </div>
      </div>

      <!-- –í—ñ–¥–ø—É—Å–∫ -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">‚ûñ –í—ñ–¥–ø—É—Å–∫ —Ç–æ–≤–∞—Ä—É</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">–î–∞—Ç–∞ *</label>
              <input type="date" id="outcomeDate" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">–ö–ª—ñ—î–Ω—Ç *</label>
              <select id="outcomeClient" class="form-select">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞...</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">–¢–æ–≤–∞—Ä *</label>
              <select id="outcomeProduct" class="form-select">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å *</label>
              <input type="number" id="outcomeQty" class="form-control" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å" min="1">
            </div>
            <div class="mb-3">
              <label class="form-label">–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ—ó</label>
              <input type="text" id="outcomeInvoice" class="form-control" placeholder="–í–ù-1234">
            </div>
            <button class="btn btn-warning w-100" id="addOutcomeBtn">‚ûñ –í—ñ–¥–ø—É—Å—Ç–∏—Ç–∏ —Ç–æ–≤–∞—Ä</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">üìã –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π (–æ—Å—Ç–∞–Ω–Ω—ñ 20)</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ß–∞—Å</th>
                <th>–¢–∏–ø</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç / –ù–∞–∫–ª–∞–¥–Ω–∞</th>
              </tr>
            </thead>
            <tbody id="operationsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/menu.js"></script>
  <script src="/static/logout.js"></script>

  <script>
    let productsData = [];
    let operationsData = [];
    let suppliersData = [];
    let clientsData = [];
    let isNewProduct = false;

    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –º—ñ–∂ —ñ—Å–Ω—É—é—á–∏–º —Ç–∞ –Ω–æ–≤–∏–º —Ç–æ–≤–∞—Ä–æ–º
    function showExistingProduct() {
      isNewProduct = false;
      document.getElementById('existingProductSection').style.display = 'block';
      document.getElementById('newProductSection').style.display = 'none';
      document.getElementById('existingProductBtn').classList.remove('btn-outline-primary');
      document.getElementById('existingProductBtn').classList.add('btn-primary');
      document.getElementById('newProductBtn').classList.remove('btn-success');
      document.getElementById('newProductBtn').classList.add('btn-outline-success');
    }

    function showNewProduct() {
      isNewProduct = true;
      document.getElementById('existingProductSection').style.display = 'none';
      document.getElementById('newProductSection').style.display = 'block';
      document.getElementById('newProductBtn').classList.remove('btn-outline-success');
      document.getElementById('newProductBtn').classList.add('btn-success');
      document.getElementById('existingProductBtn').classList.remove('btn-primary');
      document.getElementById('existingProductBtn').classList.add('btn-outline-primary');
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤
    async function loadProducts() {
      try {
        const res = await fetch('/products');
        productsData = await res.json();
        populateProductSelects();
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:', error);
      }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤
    async function loadSuppliers() {
      try {
        const res = await fetch('/api/suppliers');
        suppliersData = await res.json();
        populateSupplierSelect();
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤:', error);
      }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤
    async function loadClients() {
      try {
        const res = await fetch('/api/clients');
        clientsData = await res.json();
        populateClientSelect();
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤:', error);
      }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ–π
    async function loadOperations() {
      try {
        const res = await fetch('/api/operations');
        if (!res.ok) {
          operationsData = [];
          renderOperationsTable();
          return;
        }
        operationsData = await res.json();
        renderOperationsTable();
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ–π:', error);
        operationsData = [];
        renderOperationsTable();
      }
    }

    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ —Ç–æ–≤–∞—Ä–∞–º–∏
    function populateProductSelects() {
      const incomeSelect = document.getElementById('incomeProduct');
      const outcomeSelect = document.getElementById('outcomeProduct');

      incomeSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –∑—ñ —Å–∫–ª–∞–¥—É...</option>';
      outcomeSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...</option>';

      productsData.forEach(p => {
        const displayText = `${p.name} ${p.number ? '| ‚Ññ' + p.number : ''} | –ó–∞–ª–∏—à–æ–∫: ${p.quantity || 0}`;

        const option1 = document.createElement('option');
        option1.value = p.id;
        option1.textContent = displayText;

        const option2 = document.createElement('option');
        option2.value = p.id;
        option2.textContent = displayText;

        incomeSelect.appendChild(option1);
        outcomeSelect.appendChild(option2);
      });
    }

    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤
    function populateSupplierSelect() {
      const select = document.getElementById('incomeSupplier');
      select.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞...</option>';

      suppliersData.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.name} ${s.contact_person ? '(' + s.contact_person + ')' : ''}`;
        select.appendChild(option);
      });
    }

    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–ª—ñ—î–Ω—Ç—ñ–≤
    function populateClientSelect() {
      const select = document.getElementById('outcomeClient');
      select.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞...</option>';

      clientsData.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.name} ${c.contact_person ? '(' + c.contact_person + ')' : ''}`;
        select.appendChild(option);
      });
    }

    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π
    function renderOperationsTable() {
      const table = document.getElementById('operationsTable');
      table.innerHTML = '';

      if (operationsData.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">–û–ø–µ—Ä–∞—Ü—ñ–π –ø–æ–∫–∏ –Ω–µ–º–∞—î</td></tr>';
        return;
      }

      operationsData.forEach(op => {
        const row = document.createElement('tr');
        const typeClass = op.type === 'income' ? 'text-success' : 'text-warning';
        const typeText = op.type === 'income' ? '‚ûï –ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è' : '‚ûñ –í—ñ–¥–ø—É—Å–∫';

        const productDisplay = op.product_number
          ? `${op.product_name} | ‚Ññ${op.product_number}`
          : op.product_name;

        let counterparty = '‚Äî';
        if (op.type === 'income' && op.supplier_name) {
          counterparty = `üì¶ ${op.supplier_name}`;
        } else if (op.type === 'outcome' && op.client_name) {
          counterparty = `üë§ ${op.client_name}`;
        }

        const invoice = op.invoice_number ? `üìÑ ${op.invoice_number}` : '‚Äî';

        row.innerHTML = `
          <td>${op.date}</td>
          <td>${op.time}</td>
          <td class="${typeClass}"><strong>${typeText}</strong></td>
          <td>${productDisplay}</td>
          <td>${op.quantity}</td>
          <td><small>${counterparty}<br>${invoice}</small></td>
        `;

        table.appendChild(row);
      });
    }

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è (–û–ù–û–í–õ–ï–ù–ê –õ–û–ì–Ü–ö–ê)
    async function addIncome() {
      const quantity = parseInt(document.getElementById('incomeQty').value);
      const date = document.getElementById('incomeDate').value;
      const supplierId = document.getElementById('incomeSupplier').value;
      const invoiceNumber = document.getElementById('incomeInvoice').value.trim();

      if (!quantity || quantity <= 0) {
        alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å!');
        return;
      }

      if (!date) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É!');
        return;
      }

      if (!supplierId) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞!');
        return;
      }

      let requestData;

      if (isNewProduct) {
        // –ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä
        const name = document.getElementById('newProductName').value.trim();
        const number = document.getElementById('newProductNumber').value.trim();
        const price = parseFloat(document.getElementById('newProductPrice').value) || 0;
        const warehouse = document.getElementById('newProductWarehouse').value.trim();
        const shelf = document.getElementById('newProductShelf').value.trim();
        const rack = document.getElementById('newProductRack').value.trim();

        if (!name || !warehouse || !shelf || !rack) {
          alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É!');
          return;
        }

        requestData = {
          is_new_product: true,
          product_name: name,
          product_number: number,
          product_price: price,
          warehouse_number: warehouse,
          shelf: shelf,
          rack: rack,
          quantity: quantity,
          date: date,
          supplier_id: supplierId,
          invoice_number: invoiceNumber
        };
      } else {
        // –Ü—Å–Ω—É—é—á–∏–π —Ç–æ–≤–∞—Ä
        const productId = document.getElementById('incomeProduct').value;

        if (!productId) {
          alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä!');
          return;
        }

        requestData = {
          is_new_product: false,
          product_id: productId,
          quantity: quantity,
          date: date,
          supplier_id: supplierId,
          invoice_number: invoiceNumber
        };
      }

      try {
        const res = await fetch('/operations/income', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        if (res.ok) {
          alert('‚úÖ –ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!');
          // –û—á–∏—â—É—î–º–æ —Ñ–æ—Ä–º—É
          document.getElementById('incomeQty').value = '';
          document.getElementById('incomeProduct').value = '';
          document.getElementById('incomeSupplier').value = '';
          document.getElementById('incomeInvoice').value = '';
          document.getElementById('newProductName').value = '';
          document.getElementById('newProductNumber').value = '';
          document.getElementById('newProductPrice').value = '';
          document.getElementById('newProductWarehouse').value = '';
          document.getElementById('newProductShelf').value = '';
          document.getElementById('newProductRack').value = '';
          setTodayDate();
          showExistingProduct(); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ –≤–∏–±—ñ—Ä —ñ—Å–Ω—É—é—á–æ–≥–æ
          await loadProducts();
          await loadOperations();
        } else {
          const err = await res.json();
          alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.error);
        }
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è!');
      }
    }

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤—ñ–¥–ø—É—Å–∫—É (–±–µ–∑ –∑–º—ñ–Ω)
    async function addOutcome() {
      const productId = document.getElementById('outcomeProduct').value;
      const quantity = parseInt(document.getElementById('outcomeQty').value);
      const date = document.getElementById('outcomeDate').value;
      const clientId = document.getElementById('outcomeClient').value;
      const invoiceNumber = document.getElementById('outcomeInvoice').value.trim();

      if (!productId) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä!');
        return;
      }

      if (!quantity || quantity <= 0) {
        alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å!');
        return;
      }

      if (!date) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É!');
        return;
      }

      if (!clientId) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞!');
        return;
      }

      const product = productsData.find(p => p.id == productId);
      if (!product || product.quantity < quantity) {
        alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ–≤–∞—Ä—É –Ω–∞ —Å–∫–ª–∞–¥—ñ! –î–æ—Å—Ç—É–ø–Ω–æ: ${product?.quantity || 0}`);
        return;
      }

      try {
        const res = await fetch('/operations/outcome', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            product_id: productId,
            quantity,
            date,
            client_id: clientId,
            invoice_number: invoiceNumber
          })
        });

        if (res.ok) {
          alert('‚úÖ –í—ñ–¥–ø—É—Å–∫ —É—Å–ø—ñ—à–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–æ!');
          document.getElementById('outcomeQty').value = '';
          document.getElementById('outcomeProduct').value = '';
          document.getElementById('outcomeClient').value = '';
          document.getElementById('outcomeInvoice').value = '';
          setTodayDate();
          await loadProducts();
          await loadOperations();
        } else {
          const err = await res.json();
          alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.error);
        }
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—ñ–¥–ø—É—Å–∫—É!');
      }
    }

    // –í–∏—Ö—ñ–¥ –∑ —Å–∏—Å—Ç–µ–º–∏
    async function logout() {
      try {
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É:', error);
        window.location.href = '/login';
      }
    }

    // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—å–æ—ó –¥–∞—Ç–∏
    function setTodayDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('incomeDate').value = today;
      document.getElementById('outcomeDate').value = today;
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    window.addEventListener('load', function() {
      setTodayDate();
      showExistingProduct(); // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–æ–∫–∞–∑—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ —Ç–æ–≤–∞—Ä–∏

      document.getElementById('addIncomeBtn').addEventListener('click', addIncome);
      document.getElementById('addOutcomeBtn').addEventListener('click', addOutcome);
      document.getElementById('logoutBtn').addEventListener('click', logout);

      loadProducts();
      loadSuppliers();
      loadClients();
      loadOperations();
    });
  </script>

</body>
</html>